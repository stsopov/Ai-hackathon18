{
    "collab_server" : "",
    "contents" : "this.month.window.stat.list <- list()\n\n\nmonths <- sort(unique(user.labels$month))\n\n# get all stat for current month\nfor (m in c(\"2017-09-01\", '2017-11-01')) {\n  print(m)\n  transaction.pars <- dall[dall$month == m,]\n  transaction.pars <- transaction.pars[transaction.pars$id %in% user.labels$id[user.labels$month == m],]\n  \n  \n  transaction.pars <- transaction.pars[order(transaction.pars$id, transaction.pars$date, transaction.pars$time, decreasing = T),]\n  \n  stat_this_month <- transaction.pars %>% group_by_(.dots = \"id\") %>% summarize(\n    n_transactions = length(unique(id_trans)),\n    n_transactions_non_zero_volume = length(unique(id_trans[v_l > 0])),\n    n_transactions_zero_volume = length(unique(id_trans[v_l == 0])),\n    n_transactions_zero_sum_b = length(unique(id_trans[sum_b == 0])),\n    n_transactions_non_zero_percent = length(unique(id_trans[percent > 0])),\n    \n    sum_volume = sum(v_l),\n    average_volume = mean(v_l),\n    median_volume = median(v_l),\n    min_volume = min(v_l),\n    q25_volume = quantile(v_l, 0.25),\n    q75_volume = quantile(v_l, 0.75),\n    max_volume = max(v_l),\n    sd_volume = sd(v_l),\n    \n    sum_q = sum(q),\n    average_q = mean(q),\n    median_q = median(q),\n    min_q = min(q),\n    q25_q = quantile(q, 0.25),\n    q75_q = quantile(q, 0.75),\n    max_q = max(q),\n    sd_q = sd(q),\n    \n    sum_sum_b = sum(sum_b),\n    average_b = mean(sum_b),\n    median_b = median(sum_b),\n    min_b = min(sum_b),\n    q25_sum_b = quantile(sum_b, 0.25),\n    q75_sum_b = quantile(sum_b, 0.75),\n    max_b = max(sum_b),\n    sd_b = sd(sum_b),\n    \n    sum_percent = sum(percent),\n    average_percent = mean(percent),\n    min_percent = min(percent),\n    q25_percent = quantile(percent, 0.25),\n    q75_percent = quantile(percent, 0.75),\n    max_percent = max(percent),\n    sd_percent = sd(percent),\n    \n    \n    sum_percent_non_zero = sum(percent[percent > 0]),\n    average_percent_non_zero = mean(percent[percent > 0]),\n    min_percent_non_zero = min(percent[percent > 0]),\n    q25_percent_non_zero = quantile(percent[percent > 0], 0.25),\n    q75_percent_non_zero = quantile(percent[percent > 0], 0.75),\n    max_percent_non_zero = max(percent[percent > 0]),\n    sd_percent_non_zero = sd(percent[percent > 0]),\n    \n    n_azs = length(unique(code_azs)),\n    n_azs_percent_non_zero = length(unique(code_azs[percent > 0])),\n    n_azs_non_zero_volume = length(unique(code_azs[v_l > 0])),\n    n_azs_non_zero_volume = length(unique(code_azs[v_l > 0])),\n    \n    n_location = length(unique(location)),\n    n_location_percent_non_zero = length(unique(location[percent > 0])),\n    n_location_non_zero_volume = length(unique(location[v_l > 0])),\n    \n    n_region = length(unique(region)),\n    n_region_percent_non_zero = length(unique(region[percent > 0])),\n    n_region_non_zero_volume = length(unique(region[v_l > 0])),\n    \n    n_code = length(unique(code)),\n    n_code_percent_non_zero = length(unique(code[percent > 0])),\n    n_code_non_zero_volume = length(unique(code[v_l > 0])),\n    \n    n_code1 = length(unique(code1)),\n    n_code1_percent_non_zero = length(unique(code1[percent > 0])),\n    n_code1_non_zero_volume = length(unique(code1[v_l > 0])),\n    \n    n_types = length(unique(type)),\n    n_types_percent_non_zero = length(unique(type[percent > 0])),\n    n_types_non_zero_volume = length(unique(type[v_l > 0])),\n    \n    average_period = mean(date_diff, na.rm = T),\n    max_period = min(date_diff,  na.rm = T),\n    q25_period = quantile(date_diff, 0.25, na.rm = T),\n    q75_period = quantile(date_diff, 0.75, na.rm = T),\n    min_period = max(date_diff, na.rm = T),\n    sd_period = sd(date_diff, na.rm = T),\n    \n    sum_time_strage = sum(time == \"\"),\n    \n    average_diff_volume = mean(v_l - previous_v_l, na.rm = T),\n    min_diff_volume = min(v_l - previous_v_l,  na.rm = T),\n    max_diff_volume = max(v_l - previous_v_l, na.rm = T),\n    sd_diff_volume = sd(v_l - previous_v_l, na.rm = T), \n    \n    average_diff_period = mean(sum_b - previous_sum_b, na.rm = T),\n    min_diff_period = min(sum_b - previous_sum_b,  na.rm = T),\n    max_diff_period = max(sum_b - previous_sum_b, na.rm = T),\n    sd_diff_period = sd(sum_b - previous_sum_b, na.rm = T), \n    \n    average_diff_q = mean(q - previous_q, na.rm = T),\n    min_diff_q = min(q - previous_q,  na.rm = T),\n    max_diff_q = max(q - previous_q, na.rm = T),\n    sd_diff_q = sd(q - previous_q, na.rm = T), \n    \n    # bonus\n    bonus_got = sum(sum_b) * 0.04 - sum(percent)\n    \n\n  )\n  \n  stat_this_month$month <- m\n  colnames(stat_this_month)[!colnames(stat_this_month) %in% c(\"month\", \"id\")] <- \n    paste0(\"this_month_\", colnames(stat_this_month)[!colnames(stat_this_month) %in% c(\"month\", \"id\")])\n  \n  this.month.window.stat.list[[length(this.month.window.stat.list) + 1]] <- stat_this_month\n}\n\nthis.month.stat <- rbindlist(this.month.window.stat.list)\nthis.month.stat[is.na(this.month.stat)] <- 0\n\nsave(this.month.stat, file = \"Data/prepared/this_month_stat\")\n",
    "created" : 1520779748200.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2910041564",
    "id" : "183EBA57",
    "lastKnownWriteTime" : 1520779757,
    "last_content_update" : 1520779757462,
    "path" : "~/TEMP/AI-hack-gaz/Code/R/1_get_features_this_month.R",
    "project_path" : "Code/R/1_get_features_this_month.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 9,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}