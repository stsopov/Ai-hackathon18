{
    "collab_server" : "",
    "contents" : "getDummyVar <- function(dataset, par, min_freq) {\n  par.value <- dataset[[par]]\n  par.value[is.na(par.value)] <- \"MISSED\"\n  \n  par_freq <- table(par.value)\n  popular_pars <- names(par_freq)[par_freq >= min_freq]\n  \n  par_prep <- dataset[[par]]\n  \n  par_prep[which(!par_prep %in% popular_pars)] <- \"other\"\n  \n  dummyPar <- as.matrix(sparse.model.matrix(~-1 + ., data = data.frame(dummy.par = as.factor(par_prep))))\n  colnames(dummyPar) <- paste0(par, \"__\",1:ncol(dummyPar))\n  \n  dummyPar\n}\n\n# load cash data\n\nload(\"Data/prepared/all_stat\")\nload(\"Data/prepared/dall\")\nload(\"Data/prepared/user_labels\")\nload(\"Data/prepared/this_month_stat\")\nload(\"Data/prepared/last_year_stat\")\n\nall.stat$days_passed_after_first_p <- as.numeric(difftime(all.stat$month, \n                                                          all.stat$f_date, units = \"days\"))\n\nall.stat <- merge(all.stat, user.labels, by = c(\"id\", \"month\"))\nall.stat <- all.stat[all.stat$month != '2017-12-01',]\n\ndallFeatures <- all.stat\n\n\n# get dummy variables\ndummyMonth <- getDummyVar(dallFeatures, \"month\", 0 )\ndallFeatures <- cbind(dallFeatures, dummyMonth)\n\ndummyFMonth <- getDummyVar(dallFeatures, \"f_month\", 1000 )\ndallFeatures <- cbind(dallFeatures, dummyFMonth)\n\n\nif (F) {\n  train.miha <- read.csv(\"Data/prepared/gpn_train_data_last_3_mon_y_v4_with_split_id.csv\", stringsAsFactors = F)\n  test.miha <- read.csv(\"Data/prepared/gpn_test_data_x_v4.csv\", stringsAsFactors = F)\n  \n  train.miha$month <- ifelse(train.miha$end_time == \"1506805200\", '2017-09-01', \n                             ifelse(train.miha$end_time == \"1509397200\", '2017-10-01', '2017-11-01'))\n  test.miha$month <- ifelse(test.miha$end_time == \"1506805200\", '2017-09-01', '2017-11-01')\n  \n  train.miha <- train.miha[, order(colnames(train.miha))]\n  train.miha$ll <- NULL\n  train.miha$y <- NULL\n  test.miha <- test.miha[, order(colnames(test.miha))]\n  \n  all.miha <- rbind(train.miha, test.miha)\n  all.miha[,c('y', 'll', 'max_date_purchase', 'end_time', 'min_fp','tt','id_1','id_3','id_2')] <- NULL\n  \n  all.miha$end_time <- NULL\n  all.miha[['tt1']]=all.miha[['recency_days']]/all.miha[['mean_period']]\n  all.miha[['tt2']]=all.miha[['recency_days']]-all.miha[['mean_period']]\n  all.miha[['tt3']]=all.miha[['current_period']]/all.miha[['mean_period']]\n  all.miha[['tt4']]=all.miha[['revenue']]*0.04-all.miha[['sum_percent']]\n  all.miha[['tt5']]=all.miha[['churn']]*all.miha[['recency_days']]\n  all.miha[['tt6']]=all.miha[['month_churn']]*all.miha[['churn']]\n  all.miha[['tt7']]=all.miha[['purchases']]*all.miha[['differ_azs']]\n  all.miha[['tt8']]=all.miha[['last_volume']]/all.miha[['avpu']]\n  all.miha[['tt9']]=all.miha[['purchases']]/all.miha[['lt']]\n  \n  \n  colnames(all.miha)[!colnames(all.miha) %in% c(\"id\", \"month\")] <- paste0(colnames(all.miha)[!colnames(all.miha) %in% c(\"id\", \"month\")], \n                                                                          \"_miha\")\n  \n  dallFeatures <- merge(dallFeatures, all.miha, by = c(\"id\", \"month\"))\n}\n\ndallFeatures <- merge(dallFeatures, this.month.stat, by = c(\"id\", \"month\"))\ndallFeatures <- merge(dallFeatures, last.year.stat, by = c(\"id\", \"month\"), all.x = T)\n\n# remove some data\ndallFeatures[, c(\"f_month\", \"next_month\", \"month_diff\", \n                 \"last_purchase_date\", \"f_date\")] <- NULL\n\n# define train and test id\ntrain.id <- which(dallFeatures$is_test == 0 & \n                    dallFeatures$month %in% c(\"2017-09-01\", \"2017-11-01\") # & \n                  # dallFeatures$id %in% train_data$id\n)\n\ntest.id <- which(dallFeatures$is_test == 1 & \n                   dallFeatures$month %in% c(\"2017-09-01\", \"2017-11-01\"))\n\nTV <- dallFeatures$TV\nid <- dallFeatures$id\ndallFeatures[, c(\"id\", \"month\", \"is_test\", \"TV\")] <- NULL\n\n# some preparing and adding one feature\ndallFeatures$f_1 <- dallFeatures$day_last_purchase + dallFeatures$average_period\ndallFeatures[is.na(dallFeatures)] <- 0\ndallFeatures[(dallFeatures == -Inf)] <- 0\ndallFeatures[(dallFeatures == Inf)] <- 0\n\ndallFeatures$last_code <- NULL\ndallFeatures$last_code1 <- NULL\n",
    "created" : 1520752222461.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "0|49|15|0|\n42|8|74|0|\n",
    "hash" : "1268820158",
    "id" : "8C37D2E7",
    "lastKnownWriteTime" : 1520779719,
    "last_content_update" : 1520779719573,
    "path" : "~/TEMP/AI-hack-gaz/Code/R/1_final_feature_engineering.R",
    "project_path" : "Code/R/1_final_feature_engineering.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}